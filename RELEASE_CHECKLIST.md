# リリース前チェックリスト

## 🔴 緊急対応必須（リリース前に必ず修正）

### 1. ビルド設定の修正
- [ ] **next.config.js**: `ignoreBuildErrors: true` と `ignoreDuringBuilds: true` を削除
  - **リスク**: 型エラーやリンターエラーが本番環境にデプロイされる可能性
  - **影響**: ランタイムエラーの原因となる可能性が高い

### 2. ビルドエラーの修正
- [ ] Stripe APIキーの環境変数設定
  - エラー: `Error: Neither apiKey nor config.authenticator provided`
  - 対応: `STRIPE_SECRET_KEY` が設定されているか確認
- [ ] Importエラーの修正
  - `createCustomerPortalLink` が `@/utils/stripe` からエクスポートされていない
  - `QRCode` のインポート方法が間違っている（`qrcode.react` のデフォルトエクスポート問題）

### 3. セキュリティ脆弱性の修正
```bash
npm audit fix
```
- [ ] axios (high) - DoS攻撃の脆弱性
- [ ] body-parser (moderate) - DoS攻撃の脆弱性
- [ ] form-data (critical) - ランダム関数の脆弱性
- [ ] glob (high) - コマンドインジェクション
- [ ] js-yaml (moderate) - プロトタイプ汚染

### 4. 機密情報の確認
- [ ] `google_credentials.txt` を削除または `.gitignore` に追加
  - **リスク**: 機密情報がリポジトリに含まれる可能性
  - **対応**: ファイルを削除し、`.gitignore` で除外されているか確認

### 5. E2Eテストの修正
- [ ] データベース接続エラーの解決
  - テスト結果に「データベース接続エラー」が表示されている
  - テスト環境用の環境変数が設定されているか確認

## 🟠 高優先度（リリース前に推奨）

### 6. 環境変数の検証
- [ ] 本番環境用の環境変数チェックリスト作成
  - [ ] `NEXT_PUBLIC_SUPABASE_URL`
  - [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [ ] `SUPABASE_SERVICE_ROLE_KEY`
  - [ ] `OPENAI_API_KEY`
  - [ ] `STRIPE_SECRET_KEY`
  - [ ] `STRIPE_WEBHOOK_SECRET`
  - [ ] `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
  - [ ] `GOOGLE_CLIENT_ID`
  - [ ] `GOOGLE_CLIENT_SECRET`
  - [ ] `LINE_CHANNEL_ACCESS_TOKEN`
  - [ ] `LINE_CHANNEL_SECRET`
  - [ ] `SMTP_HOST`, `SMTP_USER`, `SMTP_PASSWORD`
  - [ ] `NEXT_PUBLIC_APP_URL`
- [ ] 起動時の環境変数バリデーション追加

### 7. ログ出力の整理
- [ ] 本番環境での `console.log/error/warn` の削除またはロガーへの置換
  - **現状**: 730箇所のconsole出力が存在
  - **対応**: 本番環境では適切なロガー（例: Sentry）を使用

### 8. APIエラーハンドリングの統一
- [ ] すべてのAPIエンドポイントで統一されたエラーレスポンス形式
- [ ] エラーロギングの実装
- [ ] 適切なHTTPステータスコードの使用

### 9. セキュリティヘッダーの確認
- [ ] `vercel.json` のセキュリティヘッダー設定が適切か確認
- [ ] Content-Security-Policyの設定
- [ ] HSTSの設定

## 🟡 中優先度（可能な限り対応）

### 10. テストカバレッジ
- [ ] テストカバレッジレポートの生成
  ```bash
  npm run test:coverage
  ```
- [ ] カバレッジが80%以上か確認
- [ ] 重要な機能のテストが不足していないか確認

### 11. ドキュメントの更新
- [ ] README.mdの最新化
  - 環境変数の説明が最新か
  - セットアップ手順が正確か
- [ ] デプロイガイドの確認
- [ ] APIドキュメントの更新

### 12. パフォーマンステスト
- [ ] ページ読み込み速度の測定
- [ ] API応答時間の確認
- [ ] バンドルサイズの確認
- [ ] 画像最適化の確認

### 13. データベース設定の確認
- [ ] RLSポリシーが適切に設定されているか
- [ ] インデックスが適切に設定されているか
- [ ] バックアップ設定の確認

## 🟢 低優先度（時間があれば対応）

### 14. 依存関係の更新
- [ ] browserslistデータの更新
  ```bash
  npx update-browserslist-db@latest
  ```

### 15. Git状態の整理
- [ ] 未追跡ファイルの整理
- [ ] mainブランチの同期（現在1コミット遅れている）
- [ ] テスト結果ファイルの整理

## デビルズアドボケイト検証ポイント

### ⚠️ 疑いを持って検証すべき点

1. **型安全性**
   - `ignoreBuildErrors: true` により、型エラーが隠蔽されている可能性
   - **検証**: 型チェックを有効にして、すべてのエラーを修正

2. **セキュリティ**
   - 環境変数が正しく設定されていない場合の動作
   - APIキーが漏洩する可能性のある箇所
   - **検証**: セキュリティ監査の実施

3. **エラーハンドリング**
   - 予期しないエラーが発生した場合の動作
   - ユーザーに適切なエラーメッセージが表示されるか
   - **検証**: エラーケースのテスト

4. **パフォーマンス**
   - 大量のデータを扱う場合のパフォーマンス
   - APIレート制限の実装
   - **検証**: 負荷テストの実施

5. **データ整合性**
   - トランザクション処理の実装
   - データの一貫性保証
   - **検証**: データ整合性テスト

6. **スケーラビリティ**
   - 同時接続数の上限
   - データベース接続プールの設定
   - **検証**: 負荷テスト

7. **監視とロギング**
   - エラーの監視体制
   - パフォーマンスメトリクスの収集
   - **検証**: 監視設定の確認

## リリース前の最終確認

- [ ] すべての緊急対応項目が完了している
- [ ] ビルドが成功する
- [ ] すべてのテストが通る
- [ ] セキュリティ監査が完了している
- [ ] ドキュメントが最新である
- [ ] 環境変数が正しく設定されている
- [ ] デプロイ手順が文書化されている
- [ ] ロールバック手順が準備されている

## リリース後の確認事項

- [ ] 本番環境での動作確認
- [ ] エラーログの監視
- [ ] パフォーマンスメトリクスの確認
- [ ] ユーザーフィードバックの収集
