# ビジネスロジック（包括版）

## 📋 目次

1. [概要](#概要)
2. [認証・認可フロー](#認証認可フロー)
3. [オンボーディングフロー](#オンボーディングフロー)
4. [レビュー管理フロー](#レビュー管理フロー)
5. [AI返信生成フロー](#ai返信生成フロー)
6. [テナント管理フロー](#テナント管理フロー)
7. [サブスクリプション管理フロー](#サブスクリプション管理フロー)
8. [Google連携フロー](#google連携フロー)
9. [通知システムフロー](#通知システムフロー)
10. [エラー処理フロー](#エラー処理フロー)

---

## 概要

RevAI Conciergeは、Google Business Profileのレビュー管理を自動化するSaaSプラットフォームです。
AIを活用してレビューへの返信を自動生成し、マルチテナントアーキテクチャで複数の事業者をサポートします。

### 主要機能
1. **認証・認可**: Supabase Auth、MFA、Google OAuth
2. **オンボーディング**: 新規ユーザー向けガイド
3. **レビュー管理**: Googleレビューの取得・管理・返信
4. **AI返信生成**: OpenAI APIを使用した自動返信生成
5. **テナント管理**: マルチテナント対応
6. **サブスクリプション**: Stripe連携による課金管理
7. **Google連携**: Google Business Profile API連携
8. **通知システム**: メール・Slack通知

---

## 認証・認可フロー

### ユーザー登録フロー

#### 正常系
1. **フォーム入力**
   - メールアドレス入力
   - パスワード入力（6文字以上）
   - パスワード確認入力

2. **バリデーション**
   - メールアドレス形式チェック: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
   - パスワード長チェック: 6文字以上
   - パスワード確認一致チェック

3. **アカウント作成**
   - Supabase Authでユーザー作成: `supabase.auth.signUp()`
   - `profiles`テーブルにレコード作成
   - `onboarding_completed = false`を設定

4. **確認メール送信**
   - Supabaseが自動的に確認メールを送信
   - メール内に確認リンクを含む

5. **メール認証**
   - ユーザーが確認リンクをクリック
   - アカウントが有効化される

6. **リダイレクト**
   - ログインページへリダイレクト
   - またはダッシュボードへ（自動ログイン）

#### 異常系

| エラーケース | 原因 | ユーザーへの表示 | HTTPステータス |
|------------|------|-----------------|---------------|
| メールアドレス形式エラー | 無効なメール形式 | 「有効なメールアドレスを入力してください」 | 400 |
| パスワード短すぎ | 6文字未満 | 「パスワードは6文字以上で入力してください」 | 400 |
| パスワード不一致 | 確認パスワードが異なる | 「パスワードが一致しません」 | 400 |
| 既存アカウント | メールアドレスが既に登録済み | 「このメールアドレスは既に登録されています」 | 400 |
| ネットワークエラー | API呼び出し失敗 | 「ネットワークエラーが発生しました。再度お試しください」 | 500 |

### ログインフロー

#### 正常系
1. **認証情報入力**
   - メールアドレス入力
   - パスワード入力

2. **Supabase認証**
   - `supabase.auth.signInWithPassword()`を呼び出し
   - JWTトークン発行

3. **セッション確認**
   - セッションが有効か確認
   - ユーザー情報を取得

4. **MFA確認（該当する場合）**
   - MFAが有効な場合、TOTPコード入力を要求
   - コード検証: `supabase.auth.verifyOtp()`

5. **オンボーディング確認**
   - `profiles.onboarding_completed`を確認
   - `false`の場合、オンボーディングウィザードを表示

6. **ダッシュボードへリダイレクト**
   - オンボーディング完了済みの場合、ダッシュボードへ
   - 未完了の場合、オンボーディングウィザードへ

#### 異常系

| エラーケース | 原因 | ユーザーへの表示 | HTTPステータス |
|------------|------|-----------------|---------------|
| 無効な認証情報 | パスワード不一致 | 「メールアドレスまたはパスワードが正しくありません」 | 401 |
| ユーザー不存在 | 未登録メール | 「メールアドレスまたはパスワードが正しくありません」 | 401 |
| メール未確認 |  | 確認メール未クリック | 「メールアドレスの確認が完了していません」 | 401 |
| アカウント無効化 | 管理者による無効化 | 「アカウントが無効化されています」 | 403 |
| レート制限 | ログイン試行回数超過 | 「しばらく待ってから再度お試しください」 | 429 |
| MFA検証失敗 | TOTPコード不一致 | 「認証コードが正しくありません」 | 401 |
| ネットワークエラー | API呼び出し失敗 | 「ネットワークエラーが発生しました」 | 500 |

### パスワードリセットフロー

#### 正常系
1. **リセットリクエスト**
   - メールアドレス入力
   - 「パスワードを忘れた場合」リンクをクリック

2. **リセットメール送信**
   - `supabase.auth.resetPasswordForEmail()`を呼び出し
   - リセットリンク付きメールを送信

3. **リセットリンククリック**
   - ユーザーがメール内のリンクをクリック
   - リセットページへリダイレクト

4. **新パスワード設定**
   - 新パスワード入力
   - パスワード確認入力
   - バリデーション

5. **パスワード更新**
   - `supabase.auth.updateUser()`でパスワード更新
   - 成功メッセージ表示

#### 異常系

| エラーケース | 原因 | ユーザーへの表示 |
|------------|------|-----------------|
| メールアドレス不存在 | 未登録メール | 「このメールアドレスは登録されていません」 |
| リセットリンク期限切れ | 24時間経過 | 「リセットリンクの有効期限が切れています」 |
| パスワード短すぎ | 6文字未満 | 「パスワードは6文字以上で入力してください」 |

---

## オンボーディングフロー

### オンボーディングウィザード

#### ステップ1: ようこそ
- **目的**: アプリケーションの紹介
- **表示内容**: 
  - アプリケーション名とロゴ
  - 主な機能の説明
  - 「次へ」ボタン

#### ステップ2: 店舗情報
- **目的**: 店舗情報の入力
- **入力項目**:
  - 店舗名（必須）
  - 店舗の種類（オプション）
  - 説明（オプション）
- **バリデーション**:
  - 店舗名は1文字以上100文字以下

#### ステップ3: Google連携
- **目的**: Google Business Profile連携の設定
- **処理**:
  - Google OAuth認証フロー開始
  - 権限許可
  - 連携完了確認
- **スキップ可能**: 後で設定可能

#### ステップ4: プラン選択
- **目的**: サブスクリプションプランの選択
- **表示内容**:
  - Freeプラン（デフォルト）
  - Proプラン
  - Enterpriseプラン
- **デフォルト**: Freeプランを選択

#### ステップ5: 完了
- **目的**: オンボーディング完了
- **処理**:
  - `profiles.onboarding_completed = true`に更新
  - ダッシュボードへリダイレクト

### 異常系

| エラーケース | 原因 | 処理 |
|------------|------|------|
| プロファイル不存在 | `profiles`テーブルにレコードなし | プロファイルを作成してから更新 |
| データベースエラー | 更新失敗 | エラーログを記録、ユーザーには成功として表示（UX優先） |
| ネットワークエラー | API呼び出し失敗 | リトライ、失敗時はエラーメッセージ表示 |

---

## レビュー管理フロー

### レビュー取得フロー

#### 手動同期（正常系）
1. **同期ボタンクリック**
   - ダッシュボードまたはレビューページで「レビュー同期」ボタンをクリック

2. **API呼び出し**
   - `POST /api/google-reviews/sync`を呼び出し
   - 認証トークンをヘッダーに含める

3. **Google API呼び出し**
   - Google Business Profile APIからレビューを取得
   - アクセストークンのリフレッシュ（必要に応じて）

4. **データベース保存**
   - 新規レビュー: `INSERT INTO reviews`
   - 既存レビュー: `UPDATE reviews`（編集された場合）
   - ステータス: `'new'`を設定

5. **通知送信（設定されている場合）**
   - 新着レビュー通知
   - 低評価レビュー通知（3星以下）

6. **UI更新**
   - レビュー一覧を更新
   - 成功メッセージ表示

#### 自動同期（バッチ処理）
1. **定期実行**
   - AWS Lambdaで毎時実行
   - すべてのテナントのレビューを同期

2. **処理フロー**
   - 手動同期と同じ処理を実行
   - エラー時はログに記録、次の実行でリトライ

#### 異常系

| エラーケース | 原因 | ユーザーへの表示 | 処理 |
|------------|------|-----------------|------|
| Google連携未設定 | OAuthトークン不存在 | 「Google連携を設定してください」 | 設定ページへ誘導 |
| トークン期限切れ | アクセストークン無効 | 「Google連携を再設定してください」 | 再認証を要求 |
| Google API エラー | API呼び出し失敗 | 「レビューの取得に失敗しました」 | エラーログ記録 |
| レート制限 | API呼び出し回数超過 | 「しばらく待ってから再度お試しください」 | リトライ推奨 |
| ネットワークエラー | 接続失敗 | 「ネットワークエラーが発生しました」 | リトライ |

### レビューステータス更新フロー

#### 正常系
1. **ステータス変更**
   - ユーザーが「対応済み」または「無視」ボタンをクリック

2. **API呼び出し**
   - `PUT /api/reviews/:id`を呼び出し
   - `{ status: 'responded' | 'ignored' }`を送信

3. **データベース更新**
   - `UPDATE reviews SET status = ? WHERE id = ?`
   - `updated_at`を更新

4. **UI更新**
   - レビューカードのステータスを更新
   - 成功メッセージ表示（オプション）

#### 異常系

| エラーケース | 原因 | ユーザーへの表示 |
|------------|------|-----------------|
| レビュー不存在 | 指定IDのレビューが存在しない | 「レビューが見つかりません」 |
| 権限不足 | 他のテナントのレビュー | 「アクセス権限がありません」 |
| データベースエラー | 更新失敗 | 「ステータスの更新に失敗しました」 |

---

## AI返信生成フロー

### 返信生成フロー（正常系）

1. **レビュー選択**
   - ユーザーがレビューを選択
   - 「AI返信を生成」ボタンをクリック

2. **トーン選択**
   - トーン選択: `formal`, `casual`, `friendly`, `professional`, `polite`
   - デフォルト: 店舗設定のトーン

3. **利用量チェック**
   - テナントの利用量を確認
   - プラン上限を確認
   - 超過時はエラー

4. **OpenAI API呼び出し**
   - `POST /api/ai-reply/generate`を呼び出し
   - プロンプト構築:
     - レビュー内容
     - 評価（星数）
     - 店舗情報
     - トーン指定
   - OpenAI APIを呼び出し: `openai.chat.completions.create()`

5. **返信文生成**
   - 生成された返信文を取得
   - サニタイズ処理

6. **データベース保存**
   - `INSERT INTO replies`
   - `is_ai_generated = true`を設定
   - レビューのステータスを`'pending'`に更新

7. **UI表示**
   - 生成された返信文をプレビュー表示
   - 編集可能なテキストエリア
   - 「承認して投稿」「再生成」ボタン

### 返信投稿フロー（正常系）

1. **返信確認**
   - ユーザーが生成された返信を確認
   - 必要に応じて編集

2. **承認**
   - 「承認して投稿」ボタンをクリック

3. **Google API呼び出し**
   - `POST /api/google-reviews/reply`を呼び出し
   - Google Business Profile APIで返信を投稿

4. **データベース更新**
   - `UPDATE replies SET posted_to_google = true`
   - `UPDATE reviews SET status = 'responded'`

5. **成功メッセージ**
   - 「返信が投稿されました」メッセージ表示

### 異常系

| エラーケース | 原因 | ユーザーへの表示 | 処理 |
|------------|------|-----------------|------|
| 利用量超過 | プラン上限に達している | 「利用量が上限に達しています。プランをアップグレードしてください」 | アップグレード誘導 |
| OpenAI API エラー | API呼び出し失敗 | 「返信の生成に失敗しました」 | リトライ推奨 |
| レート制限 | API呼び出し回数超過 | 「しばらく待ってから再度お試しください」 | リトライ |
| レビュー不存在 | 指定IDのレビューが存在しない | 「レビューが見つかりません」 | エラー表示 |
| Google投稿失敗 | Google API エラー | 「返信の投稿に失敗しました」 | エラーログ記録 |

---

## テナント管理フロー

### テナント作成フロー（正常系）

1. **新規作成ボタンクリック**
   - テナント一覧ページで「新規作成」ボタンをクリック

2. **フォーム入力**
   - テナント名（必須）
   - メールアドレス（必須）
   - プラン選択（デフォルト: `free`）

3. **バリデーション**
   - テナント名: 1文字以上100文字以下
   - メールアドレス形式チェック

4. **データベース作成**
   - `INSERT INTO tenants`
   - `status = 'active'`を設定
   - 作成者を`created_by`に設定

5. **プロファイル作成**
   - `INSERT INTO profiles`
   - `tenant_id`を設定

6. **成功メッセージ**
   - 「テナントが作成されました」メッセージ表示
   - テナント詳細ページへリダイレクト

### テナント更新フロー（正常系）

1. **編集ボタンクリック**
   - テナント詳細ページで「編集」ボタンをクリック

2. **フォーム入力**
   - テナント名を更新
   - その他の情報を更新

3. **データベース更新**
   - `UPDATE tenants SET ... WHERE id = ?`
   - `updated_at`を更新

4. **成功メッセージ**
   - 「テナント情報が更新されました」メッセージ表示

### 異常系

| エラーケース | 原因 | ユーザーへの表示 |
|------------|------|-----------------|
| テナント名重複 | 同じ名前のテナントが存在 | 「このテナント名は既に使用されています」 |
| 権限不足 | Adminロールではない | 「アクセス権限がありません」 |
| データベースエラー | 作成/更新失敗 | 「テナントの作成に失敗しました」 |

---

## サブスクリプション管理フロー

### プラン変更フロー（正常系）

1. **プラン選択**
   - 設定ページの「サブスクリプション管理」タブでプランを選択

2. **Stripeチェックアウト**
   - `POST /api/subscriptions/create-checkout-session`を呼び出し
   - Stripe Checkoutセッションを作成
   - チェックアウトページへリダイレクト

3. **支払い処理**
   - ユーザーが支払い情報を入力
   - 3Dセキュア認証（必要な場合）

4. **Webhook受信**
   - Stripeから`checkout.session.completed`イベントを受信
   - `POST /api/subscriptions/webhook`で処理

5. **データベース更新**
   - `UPDATE tenants SET plan = ?`
   - `UPDATE subscriptions SET ...`
   - 利用量カウンターをリセット

6. **確認メール送信**
   - プラン変更確認メールを送信

7. **リダイレクト**
   - 設定ページへリダイレクト
   - 成功メッセージ表示

### プランキャンセルフロー（正常系）

1. **キャンセルボタンクリック**
   - 設定ページで「キャンセル」ボタンをクリック
   - 確認ダイアログ表示

2. **確認**
   - ユーザーがキャンセルを確認

3. **Stripe API呼び出し**
   - `POST /api/subscriptions/cancel`を呼び出し
   - Stripeでサブスクリプションをキャンセル

4. **データベース更新**
   - `UPDATE tenants SET plan = 'free'`
   - `UPDATE subscriptions SET status = 'cancelled'`

5. **確認メール送信**
   - キャンセル確認メールを送信

### 異常系

| エラーケース | 原因 | ユーザーへの表示 |
|------------|------|-----------------|
| Stripe エラー | API呼び出し失敗 | 「支払い処理に失敗しました」 |
| カード拒否 | カードが無効 | 「カードが拒否されました」 |
| ネットワークエラー | 接続失敗 | 「ネットワークエラーが発生しました」 |

---

## Google連携フロー

### OAuth認証フロー（正常系）

1. **連携開始**
   - 設定ページで「Googleアカウント連携」ボタンをクリック

2. **OAuth URL生成**
   - `GET /api/auth/google-auth`を呼び出し
   - CSRF対策の`state`トークン生成
   - `oauth_states`テーブルに保存

3. **Googleログイン画面**
   - Google OAuth認証ページへリダイレクト
   - ユーザーが権限を許可

4. **コールバック処理**
   - `GET /api/auth/google-callback`で処理
   - `state`トークンを検証
   - 認証コードをトークンに交換

5. **トークン保存**
   - `google_auth_tokens`テーブルに保存
   - `access_token`, `refresh_token`, `expiry_date`を保存

6. **連携完了**
   - 設定ページへリダイレクト
   - 成功メッセージ表示

### トークンリフレッシュフロー（正常系）

1. **有効期限チェック**
   - API呼び出し前に`expiry_date`を確認
   - 期限切れの場合、リフレッシュを実行

2. **リフレッシュトークン使用**
   - `refresh_token`を使用して新しい`access_token`を取得
   - Google OAuth APIを呼び出し

3. **トークン更新**
   - `UPDATE google_auth_tokens SET access_token = ?, expiry_date = ?`

4. **API呼び出し続行**
   - 新しい`access_token`でAPI呼び出し

### 異常系

| エラーケース | 原因 | ユーザーへの表示 | 処理 |
|------------|------|-----------------|------|
| state不一致 | CSRF攻撃の可能性 | 「認証に失敗しました」 | エラー、再認証を要求 |
| 認証コード無効 | コードが期限切れ | 「認証に失敗しました」 | 再認証を要求 |
| リフレッシュトークン無効 | トークンが無効化された | 「Google連携を再設定してください」 | 再認証を要求 |
| 権限不足 | 必要なスコープが許可されていない | 「必要な権限が許可されていません」 | 再認証を要求 |

---

## 通知システムフロー

### 新着レビュー通知フロー（正常系）

1. **トリガー**
   - レビュー同期時に新規レビューが検出される

2. **通知設定確認**
   - `notification_settings.new_review_notify`を確認
   - `true`の場合、通知を送信

3. **通知送信**
   - メール通知: `POST /api/notifications/send-review-notification`
   - Slack通知: Webhook URLにPOST（設定されている場合）

4. **通知内容**
   - レビュー内容
   - 評価（星数）
   - 店舗名
   - リンク

### 低評価アラート通知フロー（正常系）

1. **トリガー**
   - レビュー同期時に3星以下のレビューが検出される

2. **通知設定確認**
   - `notification_settings.low_rating_notify`を確認
   - `low_rating_threshold`を確認

3. **通知送信**
   - メール通知
   - Slack通知（設定されている場合）

### 異常系

| エラーケース | 原因 | 処理 |
|------------|------|------|
| メール送信失敗 | SMTP エラー | エラーログ記録、リトライ |
| Slack送信失敗 | Webhook URL無効 | エラーログ記録 |

---

## エラー処理フロー

### エラーコード体系

| コード | カテゴリ | 説明 | HTTPステータス |
|--------|----------|------|---------------|
| AUTH_001 | 認証 | 未認証 | 401 |
| AUTH_002 | 認証 | セッション期限切れ | 401 |
| AUTH_003 | 認証 | MFA検証失敗 | 401 |
| PERM_001 | 権限 | アクセス権限なし | 403 |
| PERM_002 | 権限 | ロール不足 | 403 |
| VAL_001 | バリデーション | 必須フィールド不足 | 400 |
| VAL_002 | バリデーション | 形式エラー | 400 |
| LIMIT_001 | 制限 | 利用量超過 | 429 |
| LIMIT_002 | 制限 | レート制限 | 429 |
| EXT_001 | 外部連携 | Google API エラー | 502 |
| EXT_002 | 外部連携 | OpenAI API エラー | 502 |
| EXT_003 | 外部連携 | Stripe エラー | 502 |

### エラーハンドリングフロー

1. **エラー検出**
   - try-catchでエラーをキャッチ
   - エラータイプを判定

2. **エラーログ記録**
   - Sentryにエラーを送信
   - エラーログを記録

3. **ユーザーへの通知**
   - エラーメッセージを表示
   - 必要に応じてリトライを推奨

4. **リトライ（該当する場合）**
   - 一時的なエラーの場合、自動リトライ
   - 最大3回までリトライ

---

## 参考資料

- [Supabase Auth ドキュメント](https://supabase.com/docs/guides/auth)
- [Google Business Profile API ドキュメント](https://developers.google.com/my-business/content/overview)
- [OpenAI API ドキュメント](https://platform.openai.com/docs)
- [Stripe API ドキュメント](https://stripe.com/docs/api)

