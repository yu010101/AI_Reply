# Google Business Profile API レート制限ガイド

このドキュメントでは、AI Replyアプリケーションが使用するGoogle Business Profile APIのレート制限について説明します。

## レート制限とは

Google Business Profile APIには、以下の2種類のレート制限があります：

1. **クォータ制限**: 1日または1分あたりに送信できるリクエスト数の上限
2. **レート制限**: 短時間（数秒～数分）での過剰なリクエストを防ぐための制限

レート制限に達するとAPIからは「429 Too Many Requests」エラーが返され、一定時間APIを呼び出すことができなくなります。

## レート制限の上限値

Google Business Profile APIのデフォルトのレート制限は以下の通りです：

| 制限タイプ | デフォルト値 | 説明 |
|------------|--------------|------|
| クォータ/分 | 60 リクエスト | 1分間に送信できるリクエスト数 |
| クォータ/日 | 5,000 リクエスト | 1日に送信できるリクエスト数 |
| バースト/秒 | 10 リクエスト | 短時間（数秒）に連続して送信できるリクエスト数 |

## レート制限の対策

AI Replyアプリケーションでは以下の対策を実装しています：

### 1. 指数バックオフ戦略

APIエラー発生時に自動的にリトライを行います。リトライの間隔は徐々に長くなる「指数バックオフ」方式を採用しています。

```
1回目のリトライ: 1秒後
2回目のリトライ: 2秒後
3回目のリトライ: 4秒後
4回目のリトライ: 8秒後
5回目のリトライ: 16秒後
```

### 2. キャッシュの活用

頻繁にアクセスするデータ（アカウント情報、場所情報など）はデータベースにキャッシュし、APIリクエスト数を削減しています。

### 3. バッチ処理の実装

複数の処理をまとめて実行することで、APIリクエスト数を最適化しています。

## レート制限に達した場合の対応

レート制限に達した場合は、以下の対応を行ってください：

1. **待機**: 一定時間（通常は数分）待ってから再試行してください
2. **リクエスト頻度の見直し**: API呼び出しの回数や頻度を見直してください
3. **クォータ制限の引き上げ申請**: 継続的に制限に達する場合は、Google Cloud Consoleでクォータ制限の引き上げを申請してください

## クォータ制限引き上げの申請方法

1. [Google Cloud Console](https://console.cloud.google.com/) にログイン
2. 左側のメニューから「IAM と管理」→「割り当て」を選択
3. 「Google Business Profile API」を検索
4. 「割り当ての編集」をクリックして必要な割り当てを増やすリクエストを送信

※ 申請が承認されるまで数日かかる場合があります。

## トラブルシューティング

### エラーメッセージ: Quota exceeded for quota metric 'Requests'

このエラーは、APIリクエストの制限に達したことを示しています。

**解決策**:
- 一定時間（少なくとも1分以上）待ってから再試行
- リクエストの頻度を減らす
- キャッシュを活用してAPIリクエストを減らす

### エラーメッセージ: User Rate Limit Exceeded

このエラーは、短時間に多くのリクエストを送信したことを示しています。

**解決策**:
- 複数のリクエストを時間をおいて送信する
- バッチ処理を利用してリクエスト数を減らす

---

レート制限に関するさらに詳しい情報は、[Google Business Profile APIドキュメント](https://developers.google.com/my-business/reference/rest/rate-limits)を参照してください。 